apiVersion: v1
kind: ConfigMap
metadata:
  name: udp-director-config
data:
  config.yaml: |
    # Port for the Phase 1 TCP Query Server
    queryPort: 9000

    # Port for the Phase 2 TCP/UDP Data Proxy
    dataPort: 7777

    # How long a token is valid for lookup (in seconds)
    tokenTtlSeconds: 30

    # How long a data proxy session can be inactive before being torn down (in seconds)
    sessionTimeoutSeconds: 300

    # Magic byte sequence (as a hex string) that prefixes a "Control Packet"
    # This example is 4 bytes (0xFFFFFFFF) + "RESET" (0x5245534554)
    controlPacketMagicBytes: "FFFFFFFF5245534554"

    # Default endpoint query to use if no token is provided
    # This example targets pods directly using label selectors
    # Targets the starx-test deployment pods with map label
    defaultEndpoint:
      resourceType: "starx-pod"
      namespace: "starx"
      labelSelector:
        app: "starx-test"
        map: "m-tutorial"
      # Optional: Filter pods by phase (Running, Pending, etc.)
      statusQuery:
        jsonPath: "status.phase"
        expectedValues:
          - "Running"

    # Resource type definitions for client queries
    resourceQueryMapping:
      # Direct pod targeting configuration using port name lookup
      # This is the recommended approach as it's more maintainable
      starx-pod:
        group: ""
        version: "v1"
        resource: "pods"
        # Extract the pod IP directly from the pod status
        addressPath: "status.podIP"
        # Look up the port by name in the container spec
        # This searches all containers for a port named "game-udp"
        portName: "game-udp"

      # Alternative: Using JSONPath with array indexing
      # This approach is more explicit but less flexible
      starx-pod-indexed:
        group: ""
        version: "v1"
        resource: "pods"
        addressPath: "status.podIP"
        # Extract the container port using array indexing
        # [0] = first container, [0] = first port
        portPath: "spec.containers[0].ports[0].containerPort"

      # Example for targeting TCP port by name
      starx-pod-tcp:
        group: ""
        version: "v1"
        resource: "pods"
        addressPath: "status.podIP"
        # Look up the TCP port by name
        portName: "game-tcp"

      # Example for targeting a specific container's port using array indexing
      starx-pod-second-port:
        group: ""
        version: "v1"
        resource: "pods"
        addressPath: "status.podIP"
        # Target the second port in the first container
        portPath: "spec.containers[0].ports[1].containerPort"
